{% extends "base.html" %}

{% block title %}Lease {{ lease_interval_id|int }} - Lease Audit{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            {% if guarantor_name %}
                <h2>{{ guarantor_name }} <span style="font-size: 0.7em; color: #6c757d;">(Lease Interval Id: {{ lease_interval_id|int }})</span></h2>
            {% else %}
                <h2>Lease Interval ID: {{ lease_interval_id|int }}</h2>
            {% endif %}
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.property_view', property_id=property_id, run_id=run_id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Property
            </a>
        </div>
    </div>

    <!-- Summary Banner -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-light border" role="alert">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Total Undercharge:</strong> <span style="color: #c20068;">${{ "{:,.0f}".format(total_undercharge) }}</span>
                        <span class="ms-4"><strong>Total Overcharge:</strong> <span style="color: #00a8c8;">${{ "{:,.0f}".format(total_overcharge) }}</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Discrepancy Details Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">{% if exceptions %}Discrepancy Details{% else %}Audit Results{% endif %}</h5>
                </div>
                <div class="card-body p-0">
                    {% if exceptions %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>AR Code</th>
                                    <th>Scheduled Start</th>
                                    <th>Scheduled End</th>
                                    <th>Posted Date(s)</th>
                                    <th class="text-end">Scheduled Amount</th>
                                    <th class="text-end">Actual Ledger</th>
                                    <th class="text-end">Difference</th>
                                    <th class="text-center">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for exc in exceptions %}
                                <!-- Summary Row (Grouped by AR Code) -->
                                <tr class="table-active">
                                    <td>
                                        <strong>{{ exc.ar_code_id|int }}{% if exc.ar_code_name %} - {{ exc.ar_code_name }}{% endif %}</strong><br>
                                        <small><span class="badge bg-{{ exc.status_color }}">{{ exc.status_label }}</span></small>
                                        {% if exc.month_count > 1 %}
                                        <br><small class="text-muted">{{ exc.month_count }} months</small>
                                        {% endif %}
                                    </td>
                                    <td colspan="2" class="text-center text-muted">
                                        {% if exc.month_count > 1 %}
                                            Multiple months
                                        {% else %}
                                            {% set detail = exc.monthly_details[0] %}
                                            {{ detail.charge_start.strftime('%m/%d/%Y') if detail.charge_start else '-' }} to {{ detail.charge_end.strftime('%m/%d/%Y') if detail.charge_end else '-' }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center text-muted">
                                        {{ exc.all_actual_transactions|length }} transaction(s)
                                    </td>
                                    <td class="text-end"><strong>${{ "{:,.0f}".format(exc.total_expected) }}</strong></td>
                                    <td class="text-end"><strong>${{ "{:,.0f}".format(exc.total_actual) }}</strong></td>
                                    <td class="text-end">
                                        <strong class="text-{{ 'danger' if exc.total_variance < 0 else 'success' }}">
                                            ${{ "{:,.0f}".format(exc.total_variance) }}
                                        </strong>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{ loop.index }}" aria-expanded="false" title="View Monthly Details">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- Expandable Monthly Details -->
                                <tr class="collapse" id="details-{{ loop.index }}">
                                    <td colspan="8" class="p-0">
                                        <div class="bg-light p-3">
                                            <h6 class="mb-3"><i class="fas fa-calendar-alt"></i> Monthly Breakdown</h6>
                                            
                                            <table class="table table-sm table-bordered table-hover bg-white">
                                                <thead class="table-secondary">
                                                    <tr>
                                                        <th rowspan="2" class="align-middle">Month</th>
                                                        <th colspan="3" class="text-center text-info">Expected</th>
                                                        <th colspan="3" class="text-center text-primary">Actual</th>
                                                        <th rowspan="2" class="text-end align-middle">Variance</th>
                                                    </tr>
                                                    <tr>
                                                        <th class="text-info">Period Start</th>
                                                        <th class="text-info">Period End</th>
                                                        <th class="text-end text-info">Amount</th>
                                                        <th class="text-primary">Posted Date</th>
                                                        <th class="text-primary">Txn ID</th>
                                                        <th class="text-end text-primary">Amount</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for monthly in exc.monthly_details %}
                                                    {% set exp_count = monthly.expected_transactions|length %}
                                                    {% set act_count = monthly.actual_transactions|length %}
                                                    {% set max_rows = [exp_count, act_count]|max %}
                                                    {% set max_rows = max_rows if max_rows > 0 else 1 %}
                                                    
                                                    {% for i in range(max_rows) %}
                                                    <tr>
                                                        {% if i == 0 %}
                                                        <td rowspan="{{ max_rows }}" class="align-middle">
                                                            <strong>{{ monthly.audit_month.strftime('%B %Y') if monthly.audit_month else '-' }}</strong>
                                                        </td>
                                                        {% endif %}
                                                        
                                                        <!-- Expected columns -->
                                                        {% if i < exp_count %}
                                                        {% set exp = monthly.expected_transactions[i] %}
                                                        <td>{{ exp.period_start.strftime('%m/%d/%Y') if exp.period_start else '-' }}</td>
                                                        <td>{{ exp.period_end.strftime('%m/%d/%Y') if exp.period_end else '-' }}</td>
                                                        <td class="text-end">${{ "{:,.0f}".format(exp.amount) }}</td>
                                                        {% else %}
                                                        <td colspan="3" class="text-muted text-center">
                                                            {% if i == 0 %}No scheduled charges{% endif %}
                                                        </td>
                                                        {% endif %}
                                                        
                                                        <!-- Actual columns -->
                                                        {% if i < act_count %}
                                                        {% set act = monthly.actual_transactions[i] %}
                                                        <td>{{ act.post_date.strftime('%m/%d/%Y') if act.post_date else '-' }}</td>
                                                        <td><small>{{ act.transaction_id|int if act.transaction_id else '-' }}</small></td>
                                                        <td class="text-end">${{ "{:,.0f}".format(act.amount) }}</td>
                                                        {% else %}
                                                        <td colspan="3" class="text-muted text-center">
                                                            {% if i == 0 %}No actual transactions{% endif %}
                                                        </td>
                                                        {% endif %}
                                                        
                                                        {% if i == 0 %}
                                                        <td rowspan="{{ max_rows }}" class="align-middle text-end">
                                                            <strong class="text-{{ 'danger' if monthly.variance < 0 else 'success' }}">
                                                                ${{ "{:,.0f}".format(monthly.variance) }}
                                                            </strong>
                                                        </td>
                                                        {% endif %}
                                                    </tr>
                                                    {% endfor %}
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot class="table-light">
                                                    <tr>
                                                        <th>Total</th>
                                                        <th colspan="2" class="text-end">{{ exc.all_expected_transactions|length }} transaction(s)</th>
                                                        <th class="text-end">${{ "{:,.0f}".format(exc.total_expected) }}</th>
                                                        <th colspan="2" class="text-end">{{ exc.all_actual_transactions|length }} transaction(s)</th>
                                                        <th class="text-end">${{ "{:,.0f}".format(exc.total_actual) }}</th>
                                                        <th class="text-end">
                                                            <strong class="text-{{ 'danger' if exc.total_variance < 0 else 'success' }}">
                                                                ${{ "{:,.0f}".format(exc.total_variance) }}
                                                            </strong>
                                                        </th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="alert alert-success m-3" role="alert">
                            <h5><i class="fas fa-check-circle"></i> Clean Audit - No Exceptions</h5>
                            <p class="mb-0">All scheduled charges for this lease matched the actual billed amounts perfectly. No discrepancies found.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Matched Records Table -->
    {% if matched_records %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle"></i> Matched Charges ({{ matched_count }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>AR Code</th>
                                    <th class="text-center">Months</th>
                                    <th class="text-end">Total Amount</th>
                                    <th class="text-center">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for match in matched_records %}
                                <!-- Summary Row -->
                                <tr class="table-success">
                                    <td>
                                        <strong>{{ match.ar_code_id|int }}{% if match.ar_code_name %} - {{ match.ar_code_name }}{% endif %}</strong><br>
                                        <small class="text-muted">{{ match.month_count }} month(s) matched</small>
                                    </td>
                                    <td class="text-center">{{ match.month_count }}</td>
                                    <td class="text-end"><strong>${{ "{:,.0f}".format(match.total_amount) }}</strong></td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-success" type="button" data-bs-toggle="collapse" data-bs-target="#match-{{ loop.index }}" aria-expanded="false" title="View Monthly Details">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </td>
                                </tr>
                                <!-- Expandable Monthly Details -->
                                <tr class="collapse" id="match-{{ loop.index }}">
                                    <td colspan="4" class="p-0">
                                        <div class="bg-light p-3">
                                            <h6 class="mb-3"><i class="fas fa-calendar-check"></i> Monthly Breakdown</h6>
                                            
                                            <table class="table table-sm table-bordered bg-white">
                                                <thead class="table-secondary">
                                                    <tr>
                                                        <th rowspan="2" class="align-middle">Month</th>
                                                        <th colspan="3" class="text-center text-info">Expected</th>
                                                        <th colspan="3" class="text-center text-success">Actual (Matched)</th>
                                                    </tr>
                                                    <tr>
                                                        <th class="text-info">Period Start</th>
                                                        <th class="text-info">Period End</th>
                                                        <th class="text-end text-info">Amount</th>
                                                        <th class="text-success">Posted Date</th>
                                                        <th class="text-success">Txn ID</th>
                                                        <th class="text-end text-success">Amount</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for monthly in match.monthly_details %}
                                                    {% set exp_count = monthly.expected_transactions|length %}
                                                    {% set act_count = monthly.actual_transactions|length %}
                                                    {% set max_rows = [exp_count, act_count]|max %}
                                                    {% set max_rows = max_rows if max_rows > 0 else 1 %}
                                                    
                                                    {% for i in range(max_rows) %}
                                                    <tr>
                                                        {% if i == 0 %}
                                                        <td rowspan="{{ max_rows }}" class="align-middle">
                                                            <strong>{{ monthly.audit_month.strftime('%B %Y') if monthly.audit_month else '-' }}</strong>
                                                        </td>
                                                        {% endif %}
                                                        
                                                        <!-- Expected columns -->
                                                        {% if i < exp_count %}
                                                        {% set exp = monthly.expected_transactions[i] %}
                                                        <td>{{ exp.period_start.strftime('%m/%d/%Y') if exp.period_start else '-' }}</td>
                                                        <td>{{ exp.period_end.strftime('%m/%d/%Y') if exp.period_end else '-' }}</td>
                                                        <td class="text-end">${{ "{:,.0f}".format(exp.amount) }}</td>
                                                        {% else %}
                                                        <td colspan="3" class="text-muted text-center">-</td>
                                                        {% endif %}
                                                        
                                                        <!-- Actual columns -->
                                                        {% if i < act_count %}
                                                        {% set act = monthly.actual_transactions[i] %}
                                                        <td>{{ act.post_date.strftime('%m/%d/%Y') if act.post_date else '-' }}</td>
                                                        <td><small>{{ act.transaction_id|int if act.transaction_id else '-' }}</small></td>
                                                        <td class="text-end">${{ "{:,.0f}".format(act.amount) }}</td>
                                                        {% else %}
                                                        <td colspan="3" class="text-muted text-center">-</td>
                                                        {% endif %}
                                                    </tr>
                                                    {% endfor %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Lease Metadata -->
    <div class="row mt-3 mb-4">
        <div class="col-12">
            <p class="text-muted small">
                {% if property_name %}
                    Property: <strong>{{ property_name }}</strong> (ID: {{ property_id|int }})
                {% else %}
                    Property ID: <code>{{ property_id|int }}</code>
                {% endif %}
                {% if metadata.audit_period %}
                | <strong>Audit Period: 
                {% if metadata.audit_period.month %}
                    {{ ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][metadata.audit_period.month] }}
                {% endif %}
                {% if metadata.audit_period.year %}
                    {{ metadata.audit_period.year }}
                {% endif %}
                </strong>
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% endblock %}
