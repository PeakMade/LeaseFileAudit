{% extends "base.html" %}

{% block title %}Lease {{ lease_interval_id|int }} - Lease Audit{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            {% if customer_name %}
                <h2>{{ customer_name }} <span style="font-size: 0.7em; color: #6c757d;">(Lease Interval Id: {{ lease_interval_id|int }})</span></h2>
            {% else %}
                <h2>Lease Interval ID: {{ lease_interval_id|int }}</h2>
            {% endif %}
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.property_view', property_id=property_id, run_id=run_id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Property
            </a>
        </div>
    </div>

    <!-- Summary Banner -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-light border" role="alert">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Total Undercharge:</strong> <span style="color: #c20068;">${{ "{:,.0f}".format(total_undercharge) }}</span>
                        <span class="ms-4"><strong>Total Overcharge:</strong> <span style="color: #00a8c8;">${{ "{:,.0f}".format(total_overcharge) }}</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified AR Codes Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">AR Code Details</h5>
                </div>
                <div class="card-body p-0">
                    {% if all_ar_codes %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 120px;">AR Code</th>
                                    <th>AR Code Name</th>
                                    <th class="text-center" style="width: 120px;">Matched</th>
                                    <th class="text-center" style="width: 120px;">Exceptions</th>
                                    <th class="text-center" style="width: 80px;">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ar_code in all_ar_codes %}
                                <tr>
                                    <td><strong>{{ ar_code.ar_code_id|int }}</strong></td>
                                    <td>{{ ar_code.ar_code_name if ar_code.ar_code_name else '-' }}</td>
                                    <td class="text-center">
                                        {% if ar_code.matched_count > 0 %}
                                        <span class="badge bg-success">{{ ar_code.matched_count }}</span>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if ar_code.exception_count > 0 %}
                                        <span class="badge bg-danger">{{ ar_code.exception_count }}</span>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                onclick="openDrawer({{ loop.index0 }})"
                                                title="View Details">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="alert alert-success m-3" role="alert">
                            <h5><i class="fas fa-check-circle"></i> Clean Audit - No Charges Found</h5>
                            <p class="mb-0">No AR codes found for this lease.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Side Drawer for AR Code Details -->
    <div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawer()"></div>
    <div id="detailsDrawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h5 class="mb-0" id="drawerTitle">AR Code Details</h5>
                <button type="button" class="btn-close" onclick="closeDrawer()"></button>
            </div>
            <div class="drawer-body" id="drawerBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Hidden data for drawer content -->
    <script>
    const arCodeData = {{ all_ar_codes|tojson|safe }};
    
    function openDrawer(index) {
        const data = arCodeData[index];
        const drawer = document.getElementById('detailsDrawer');
        const title = document.getElementById('drawerTitle');
        const body = document.getElementById('drawerBody');
        
        title.textContent = `${data.ar_code_id} - ${data.ar_code_name || 'Unknown'}`;
        
        // Build drawer content
        let content = '<div class="mb-3">';
        content += `<div class="d-flex gap-2 mb-3">`;
        if (data.matched_count > 0) {
            content += `<span class="badge bg-success">${data.matched_count} Matched</span>`;
        }
        if (data.exception_count > 0) {
            content += `<span class="badge bg-danger">${data.exception_count} Exception(s)</span>`;
        }
        content += '</div>';
        content += '</div>';
        
        // Monthly details table
        content += '<table class="table table-sm table-bordered">';
        content += '<thead class="table-secondary">';
        content += '<tr>';
        content += '<th class="align-middle">Month</th>';
        content += '<th colspan="2" class="text-center text-info">Expected</th>';
        content += '<th colspan="2" class="text-center text-primary">Actual</th>';
        content += '</tr>';
        content += '<tr>';
        content += '<th></th>';
        content += '<th class="text-info">Period</th>';
        content += '<th class="text-end text-info">Amount</th>';
        content += '<th class="text-primary">Post Date</th>';
        content += '<th class="text-end text-primary">Amount</th>';
        content += '</tr>';
        content += '</thead>';
        content += '<tbody>';
        
        // Add monthly rows
        if (data.monthly_details && data.monthly_details.length > 0) {
            data.monthly_details.forEach(month => {
                const expTrans = month.expected_transactions || [];
                const actTrans = month.actual_transactions || [];
                const maxRows = Math.max(expTrans.length, actTrans.length, 1);
                const isException = month.status !== 'matched';
                const rowClass = isException ? 'table-danger' : '';
                
                for (let i = 0; i < maxRows; i++) {
                    content += `<tr class="${rowClass}">`;
                    
                    // Month column (only first row)
                    if (i === 0) {
                        let monthLabel = formatDate(month.audit_month, 'MMMM YYYY');
                        if (isException) {
                            monthLabel += ` <span class="badge bg-${month.status_color}">${month.status_label}</span>`;
                        }
                        content += `<td rowspan="${maxRows}" class="align-middle"><strong>${monthLabel}</strong></td>`;
                    }
                    
                    // Expected columns
                    if (i < expTrans.length) {
                        const exp = expTrans[i];
                        content += `<td><small>${formatDate(exp.period_start, 'MM/DD/YYYY')} - ${formatDate(exp.period_end, 'MM/DD/YYYY')}</small></td>`;
                        content += `<td class="text-end">$${formatNumber(exp.amount)}</td>`;
                    } else {
                        content += '<td colspan="2" class="text-muted text-center"><em>No scheduled charges</em></td>';
                    }
                    
                    // Actual columns
                    if (i < actTrans.length) {
                        const act = actTrans[i];
                        content += `<td>${formatDate(act.post_date, 'MM/DD/YYYY')}</td>`;
                        content += `<td class="text-end">$${formatNumber(act.amount)}</td>`;
                    } else {
                        content += '<td colspan="2" class="text-muted text-center"><em>No actual transactions</em></td>';
                    }
                    
                    content += '</tr>';
                }
            });
        } else {
            content += '<tr><td colspan="5" class="text-center text-muted">No monthly details available</td></tr>';
        }
        
        content += '</tbody>';
        content += '</table>';
        
        body.innerHTML = content;
        drawer.classList.add('open');
        document.getElementById('drawerOverlay').classList.add('open');
    }
    
    function closeDrawer() {
        document.getElementById('detailsDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
    }
    
    function formatDate(dateStr, format) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '-';
        
        if (format === 'MMMM YYYY') {
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        } else if (format === 'MM/DD/YYYY') {
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }
        return date.toLocaleDateString();
    }
    
    function formatNumber(num) {
        if (num === null || num === undefined) return '0';
        return Math.round(num).toLocaleString();
    }
    </script>

    <style>
    .drawer {
        position: fixed;
        top: 0;
        right: -800px;
        width: 800px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 1051;
        overflow-y: auto;
    }
    
    .drawer.open {
        right: 0;
    }
    
    .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        display: none;
    }
    
    .drawer-overlay.open {
        display: block;
    }
    
    .drawer-content {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .drawer-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
    }
    
    .drawer-body {
        padding: 1.5rem;
        flex: 1;
        overflow-y: auto;
    }
    </style>
    
    <!-- Lease Metadata -->
    <div class="row mt-3 mb-4">
        <div class="col-12">
            <p class="text-muted small">
                {% if property_name %}
                    Property: <strong>{{ property_name }}</strong> (ID: {{ property_id|int }})
                {% else %}
                    Property ID: <code>{{ property_id|int }}</code>
                {% endif %}
                {% if metadata.audit_period %}
                | <strong>Audit Period: 
                {% if metadata.audit_period.month %}
                    {{ ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][metadata.audit_period.month] }}
                {% endif %}
                {% if metadata.audit_period.year %}
                    {{ metadata.audit_period.year }}
                {% endif %}
                </strong>
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% endblock %}
