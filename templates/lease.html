{% extends "base.html" %}

{% block title %}Lease {{ lease_interval_id|int }} - Lease Audit{% endblock %}

{% block content %}
<!-- Action Buttons (positioned next to user badge) -->
<div class="action-buttons-container">
    {% if has_customer_id %}
    <a href="{{ entrata_url }}" target="_blank" class="btn btn-primary" title="Open resident profile in Entrata (Customer ID: {{ customer_id }})">
        <i class="fas fa-external-link-alt"></i> Open in Entrata
    </a>
    {% else %}
    <button class="btn btn-primary" disabled title="Customer ID not available - button disabled">
        <i class="fas fa-external-link-alt"></i> Open in Entrata
    </button>
    {% endif %}
    <a href="{{ url_for('main.property_view', property_id=property_id, run_id=run_id) }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Property
    </a>
</div>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            {% if customer_name %}
                <h2>{{ customer_name }} <span style="font-size: 0.7em; color: #6c757d;">(Lease Interval Id: {{ lease_interval_id|int }})</span></h2>
            {% else %}
                <h2>Lease Interval ID: {{ lease_interval_id|int }}</h2>
            {% endif %}
        </div>
    </div>

    <!-- Summary Banner -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-light border" role="alert">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Total Undercharge:</strong> <span style="color: #c20068;">${{ "{:,.0f}".format(total_undercharge) }}</span>
                        <span class="ms-4"><strong>Total Overcharge:</strong> <span style="color: #00a8c8;">${{ "{:,.0f}".format(total_overcharge) }}</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified AR Codes Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">AR Code Details</h5>
                </div>
                <div class="card-body p-0">
                    {% if all_ar_codes %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 120px;">AR Code</th>
                                    <th>AR Code Name</th>
                                    <th class="text-center" style="width: 120px;">Matched</th>
                                    <th class="text-center" style="width: 120px;">Exceptions</th>
                                    <th class="text-center" style="width: 180px;">Status</th>
                                    <th class="text-center" style="width: 80px;">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ar_code in all_ar_codes %}
                                <tr data-ar-code-id="{{ ar_code.ar_code_id }}" 
                                    onclick="openDrawer({{ loop.index0 }})" 
                                    style="cursor: pointer;" 
                                    class="ar-code-row">
                                    <td><strong>{{ ar_code.ar_code_id|int }}</strong></td>
                                    <td>{{ ar_code.ar_code_name if ar_code.ar_code_name else '-' }}</td>
                                    <td class="text-center">
                                        {% if ar_code.matched_count > 0 %}
                                        <span class="badge bg-success">{{ ar_code.matched_count }}</span>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if ar_code.exception_count > 0 %}
                                        <span class="badge bg-danger">{{ ar_code.exception_count }}</span>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-{{ ar_code.status_color }} ar-status-badge" id="arStatusBadge-{{ loop.index0 }}">{{ ar_code.status_label }}</span>
                                    </td>
                                    <td class="text-center">
                                        <i class="fas fa-eye text-secondary"></i>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="alert alert-success m-3" role="alert">
                            <h5><i class="fas fa-check-circle"></i> Clean Audit - No Charges Found</h5>
                            <p class="mb-0">No AR codes found for this lease.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Side Drawer for AR Code Details -->
    <div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawer()"></div>
    <div id="detailsDrawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h5 class="mb-0" id="drawerTitle">AR Code Details</h5>
                <button type="button" class="btn-close" onclick="closeDrawer()"></button>
            </div>
            <div class="drawer-body" id="drawerBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Hidden data for drawer content -->
    <script>
    const arCodeData = {{ all_ar_codes|tojson|safe }};
    let currentDrawerData = null;  // Track currently open drawer data
    let currentArCodeId = null;    // Track currently open AR code ID
    const exceptionState = {};
    const hasCustomerId = {{ 'true' if has_customer_id else 'false' }};
    const currentUserName = "{{ user.name if user else 'Unknown' }}";

    function getExceptionKey(data, exceptionType) {
        return `{{ run_id }}:{{ property_id }}:{{ lease_interval_id }}:${data.ar_code_id}:${exceptionType || 'UNKNOWN'}`;
    }

    function normalizeWorkflowStatus(status) {
        if (!status) return 'Open';
        const normalized = String(status).trim().toLowerCase();
        if (normalized === 'resolved') return 'Resolved';
        if (normalized === 'open') return 'Open';
        // Treat any old "in progress" as open
        if (normalized === 'in progress' || normalized === 'in_progress') return 'Open';
        return status;
    }

    function getStatusMeta(status) {
        const normalized = normalizeWorkflowStatus(status);
        if (normalized === 'Resolved') return { label: 'Resolved', color: 'success' };
        if (normalized === 'Open') return { label: 'Open', color: 'danger' };
        return { label: 'Clean', color: 'success' };
    }

    function getOrInitState(data) {
        const key = String(data.ar_code_id);
        if (!exceptionState[key]) {
            const hasExceptions = data.exception_count > 0;
            const exception = (data.monthly_details || []).find(m => m.status !== 'matched');
            const exceptionType = exception ? exception.status : null;
            const storedState = exceptionState[key] || null;
            exceptionState[key] = {
                status: storedState?.status || (hasExceptions ? 'Open' : 'Clean'),
                fixLabel: storedState?.fixLabel || null,
                actionType: storedState?.actionType || null,
                resolvedAt: storedState?.resolvedAt || null,
                exceptionType: exceptionType,
                originalFixLabel: storedState?.originalFixLabel || storedState?.fixLabel || null,
                updatedFixLabel: storedState?.updatedFixLabel || storedState?.fixLabel || null,
                resolvedMonths: storedState?.resolvedMonths || []
            };
        }
        return exceptionState[key];
    }

    // Status badges are already set correctly from backend - no need to override them on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Status calculation happens on the backend based on SharePoint month data
        // The status_label in the HTML is already correct, don't override it
    });
    
    function openDrawer(index) {
        const data = arCodeData[index];
        currentDrawerData = data;  // Store for later use
        currentArCodeId = data.ar_code_id;  // Store AR code ID
        const state = getOrInitState(data);
        const drawer = document.getElementById('detailsDrawer');
        const title = document.getElementById('drawerTitle');
        const body = document.getElementById('drawerBody');
        // Use backend status instead of JavaScript state
        const backendStatus = data.status_label || 'Open';
        const statusColor = data.status_color || 'warning';
        const hasSelectionChanged = !!(state.originalFixLabel && state.updatedFixLabel && state.originalFixLabel !== state.updatedFixLabel);
        
        title.textContent = `${data.ar_code_id} - ${data.ar_code_name || 'Unknown'}`;
        
        // Build drawer content
        let content = '<div class="mb-3">';
        content += `<div class="d-flex gap-2 mb-3 align-items-center">`;
        if (data.matched_count > 0) {
            content += `<span class="badge bg-success">${data.matched_count} Matched</span>`;
        }
        if (data.exception_count > 0) {
            content += `<span class="badge bg-danger">${data.exception_count} Exception(s)</span>`;
        }
        content += `<span class="badge bg-${statusColor}" id="drawerStatusBadge">${backendStatus}</span>`;
        content += '</div>';

        // Exception Workflow section - moved to top
        if (data.exception_count > 0 || (data.monthly_details || []).some(m => m.status !== 'matched' && m.month_status === 'Resolved')) {
            // Count total exceptions (including resolved) and open exceptions
            const allExceptions = (data.monthly_details || []).filter(m => m.status !== 'matched');
            const resolvedExceptions = allExceptions.filter(m => m.month_status === 'Resolved');
            const openExceptions = allExceptions.filter(m => m.month_status !== 'Resolved');
            
            const exception = openExceptions[0] || allExceptions[0];
            const status = exception ? exception.status : null;
            const statusLabel = exception ? exception.status_label : 'Exception';
            
            let headerText = '';
            if (openExceptions.length > 0 && resolvedExceptions.length > 0) {
                headerText = `<strong>${statusLabel}</strong> detected across ${allExceptions.length} month${allExceptions.length > 1 ? 's' : ''} (${resolvedExceptions.length} resolved)`;
            } else if (openExceptions.length > 0) {
                headerText = `<strong>${statusLabel}</strong> detected across ${openExceptions.length} month${openExceptions.length > 1 ? 's' : ''}`;
            } else {
                headerText = `All ${resolvedExceptions.length} exception month${resolvedExceptions.length > 1 ? 's have' : ' has'} been resolved`;
            }

            content += `
                <h5 class="mb-3"><i class="fas fa-tasks"></i> Exception Workflow</h5>
                <p class="text-muted mb-3">${headerText}</p>
            `;
        }
        
        content += '</div>';
        
        // Monthly details table
        content += '<table class="table table-sm table-bordered">';
        content += '<thead class="table-secondary">';
        content += '<tr>';
        content += '<th style="width: 30px;"></th>';
        content += '<th class="align-middle">Month</th>';
        content += '<th colspan="2" class="text-center text-dark">Expected</th>';
        content += '<th colspan="2" class="text-center text-dark">Actual</th>';
        content += '</tr>';
        content += '<tr>';
        content += '<th></th>';
        content += '<th></th>';
        content += '<th class="text-dark">Period</th>';
        content += '<th class="text-end text-dark">Amount</th>';
        content += '<th class="text-dark">Post Date</th>';
        content += '<th class="text-end text-dark">Amount</th>';
        content += '</tr>';
        content += '</thead>';
        content += '<tbody>';
        
        // Add monthly rows
        if (data.monthly_details && data.monthly_details.length > 0) {
            data.monthly_details.forEach((month, monthIndex) => {
                const expTrans = month.expected_transactions || [];
                const actTrans = month.actual_transactions || [];
                const maxRows = Math.max(expTrans.length, actTrans.length, 1);
                const isException = month.status !== 'matched';
                const isResolved = month.month_status === 'Resolved';
                
                // Determine row styling based on exception and resolution status
                let rowClass = '';
                let rowStyle = '';
                if (isException) {
                    if (isResolved) {
                        rowClass = 'table-secondary';  // Grey background for resolved
                        rowStyle = 'opacity: 0.6;';     // Fade out resolved exceptions
                    } else {
                        rowClass = 'table-danger';      // Red background for open exceptions
                    }
                }
                
                for (let i = 0; i < maxRows; i++) {
                    content += `<tr class="${rowClass}" style="${rowStyle}" data-month-index="${monthIndex}">`;
                    
                    // Checkbox column (only first row and only for exceptions)
                    if (i === 0) {
                        if (isException) {
                            content += `<td rowspan="${maxRows}" class="align-middle text-center">
                                <input type="checkbox" class="form-check-input exception-row-checkbox" data-month-index="${monthIndex}" data-audit-month="${month.audit_month}">
                            </td>`;
                        } else {
                            content += `<td rowspan="${maxRows}"></td>`;
                        }
                    }
                    
                    // Month column (only first row)
                    if (i === 0) {
                        let monthLabel = formatDate(month.audit_month, 'MMMM YYYY');
                        if (isException) {
                            // Show resolution status badge if resolved, otherwise show exception type badge
                            if (isResolved) {
                                monthLabel += ` <span class="badge bg-success">Resolved</span>`;
                            } else {
                                monthLabel += ` <span class="badge bg-${month.status_color}">${month.status_label}</span>`;
                            }
                        }
                        content += `<td rowspan="${maxRows}" class="align-middle"><strong>${monthLabel}</strong></td>`;
                    }
                    
                    // Expected columns
                    if (i < expTrans.length) {
                        const exp = expTrans[i];
                        content += `<td><small>${formatDate(exp.period_start, 'MM/DD/YYYY')} - ${formatDate(exp.period_end, 'MM/DD/YYYY')}</small></td>`;
                        content += `<td class="text-end">$${formatNumber(exp.amount)}</td>`;
                    } else {
                        // No scheduled charges - this is BILLED_NOT_SCHEDULED (billed without schedule)
                        if (i === 0 && isException && month.status === 'BILLED_NOT_SCHEDULED') {
                            content += `<td rowspan="${maxRows}" colspan="2" class="text-center align-middle expected-fix-cell" id="expectedFix-${monthIndex}"><em class="text-muted">No scheduled charges</em></td>`;
                        } else if (i === 0) {
                            content += `<td rowspan="${maxRows}" colspan="2" class="text-muted text-center align-middle"><em>No scheduled charges</em></td>`;
                        }
                    }
                    
                    // Actual columns
                    if (i < actTrans.length) {
                        const act = actTrans[i];
                        content += `<td>${formatDate(act.post_date, 'MM/DD/YYYY')}</td>`;
                        content += `<td class="text-end">$${formatNumber(act.amount)}</td>`;
                    } else {
                        // No actual transactions - this is SCHEDULED_NOT_BILLED (scheduled but not billed)
                        if (i === 0 && isException && month.status === 'SCHEDULED_NOT_BILLED') {
                            content += `<td rowspan="${maxRows}" colspan="2" class="text-center align-middle actual-fix-cell" id="actualFix-${monthIndex}"><em class="text-muted">No actual transactions</em></td>`;
                        } else if (i === 0) {
                            content += `<td rowspan="${maxRows}" colspan="2" class="text-muted text-center align-middle"><em>No actual transactions</em></td>`;
                        }
                    }
                    
                    content += '</tr>';
                }
            });
        } else {
            content += '<tr><td colspan="4" class="text-center text-muted">No monthly details available</td></tr>';
        }
        
        content += '</tbody>';
        content += '</table>';

        // Suggested fixes as horizontal buttons below table
        // Show if there are exceptions (including resolved ones)
        if (data.exception_count > 0 || (data.monthly_details || []).some(m => m.status !== 'matched')) {
            const exceptions = (data.monthly_details || []).filter(m => m.status !== 'matched');
            const hasUnresolvedExceptions = exceptions.some(m => m.month_status !== 'Resolved');
            const allResolved = !hasUnresolvedExceptions && exceptions.length > 0;
            
            const exception = exceptions.find(m => m.month_status !== 'Resolved') || exceptions[0];
            const status = exception ? exception.status : null;
            
            const allResolvedClass = allResolved ? 'all-resolved' : '';
            
            content += `
                <div class="mb-3 suggested-fixes ${allResolvedClass}">
                    <h6 class="mb-2"><i class="fas fa-lightbulb"></i> Suggested Fixes ${allResolved ? '<span class="text-muted">(All Resolved)</span>' : ''}</h6>
                    <div class="d-flex gap-2 flex-wrap" id="suggestedFixButtons">
                        ${buildSuggestedFixButtons(status)}
                    </div>
                </div>
            `;
        }
        
        body.innerHTML = content;
        
        // Populate fix cells and checkbox states from month-level data
        if (data.monthly_details && data.monthly_details.length > 0) {
            data.monthly_details.forEach((month, monthIndex) => {
                // Only process exception months (not matched ones)
                if (month.status === 'matched') return;
                
                const checkbox = document.querySelector(`.exception-row-checkbox[data-month-index="${monthIndex}"]`);
                // Determine which cell to update based on exception type
                const isBilledNotScheduled = month.status === 'BILLED_NOT_SCHEDULED';
                const fixCell = isBilledNotScheduled 
                    ? document.getElementById(`expectedFix-${monthIndex}`)
                    : document.getElementById(`actualFix-${monthIndex}`);
                
                // Check if this month has been resolved (from SharePoint)
                if (month.month_status === 'Resolved') {
                    // This month is resolved
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.disabled = true;
                        // Row styling is already applied during table generation
                    }
                    if (fixCell && month.month_fix_label) {
                        let resolvedInfo = '';
                        if (month.month_resolved_at) {
                            const resolvedByName = month.month_resolved_by_name || month.month_resolved_by || 'Unknown';
                            resolvedInfo = `<br/><small style="font-size: 0.7rem; color: #6c757d;">${formatDateTime(month.month_resolved_at)} by ${resolvedByName}</small>`;
                        }
                        fixCell.innerHTML = `<span class="badge bg-success">✓</span> ${month.month_fix_label}${resolvedInfo}`;
                    }
                } else if (month.month_status === 'Open') {
                    // Month is still open - show the original placeholder text
                    if (fixCell) {
                        if (isBilledNotScheduled) {
                            fixCell.innerHTML = '<em class="text-muted">No scheduled charges</em>';
                        } else {
                            fixCell.innerHTML = '<em class="text-muted">No actual transactions</em>';
                        }
                    }
                }
            });
        }
        
        drawer.classList.add('open');
        document.getElementById('drawerOverlay').classList.add('open');
    }
    
    function closeDrawer() {
        document.getElementById('detailsDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
    }
    
    // Exceptions workflow drawer functions
    function selectFix(element, fixIndex) {
        // Remove selected class from all fixes
        document.querySelectorAll('.suggested-fix').forEach(fix => {
            fix.classList.remove('selected');
        });
        // Add selected class to clicked fix
        element.classList.add('selected');
    }

    function buildSuggestedFixes(status) {
        if (status === 'SCHEDULED_NOT_BILLED') {
            return `
                <div class="suggested-fix mb-2" data-fix-label="Post missing charge in Entrata" onclick="selectFix(this, 0)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">1</span>
                        <div class="flex-grow-1">
                            <strong>Post missing charge in Entrata</strong>
                            <p class="mb-1 text-muted small">The scheduled charge exists but was never billed. Post the AR transaction in Entrata.</p>
                            <button class="btn btn-sm btn-suggested-primary mt-1" onclick="applyFix(event, 'Post missing charge in Entrata', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix mb-2" data-fix-label="Correct schedule dates" onclick="selectFix(this, 1)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">2</span>
                        <div class="flex-grow-1">
                            <strong>Correct schedule dates</strong>
                            <p class="mb-1 text-muted small">The schedule may have incorrect start/end dates. Review and adjust the recurring charge schedule.</p>
                            <button class="btn btn-sm btn-suggested-outline mt-2" onclick="applyFix(event, 'Correct schedule dates', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix" data-fix-label="Mark as expected exception" onclick="selectFix(this, 2)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">3</span>
                        <div class="flex-grow-1">
                            <strong>Mark as expected exception</strong>
                            <p class="mb-1 text-muted small">This may be expected (move-out, MTM, concession, etc.). Document the reason and mark as resolved.</p>
                            <button class="btn btn-sm btn-suggested-outline mt-2" onclick="applyFix(event, 'Mark as expected exception', 'one_time')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        if (status === 'BILLED_NOT_SCHEDULED') {
            return `
                <div class="suggested-fix mb-2" data-fix-label="Add recurring charge to schedule" onclick="selectFix(this, 0)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">1</span>
                        <div class="flex-grow-1">
                            <strong>Add recurring charge to schedule</strong>
                            <p class="mb-1 text-muted small">A charge was billed but no schedule exists. Create or update the recurring charge in Entrata.</p>
                            <button class="btn btn-sm btn-suggested-primary mt-1" onclick="applyFix(event, 'Add recurring charge to schedule', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix mb-2" data-fix-label="Reverse incorrect charge" onclick="selectFix(this, 1)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">2</span>
                        <div class="flex-grow-1">
                            <strong>Reverse incorrect charge</strong>
                            <p class="mb-1 text-muted small">The charge was posted in error. Reverse the transaction in Entrata.</p>
                            <button class="btn btn-sm btn-suggested-outline mt-2" onclick="applyFix(event, 'Reverse incorrect charge', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix" data-fix-label="Mark as one-time charge" onclick="selectFix(this, 2)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">3</span>
                        <div class="flex-grow-1">
                            <strong>Mark as one-time charge</strong>
                            <p class="mb-1 text-muted small">This is a legitimate one-time charge. Document and mark as resolved.</p>
                            <button class="btn btn-sm btn-suggested-outline mt-2" onclick="applyFix(event, 'Mark as one-time charge', 'one_time')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        if (status === 'AMOUNT_MISMATCH') {
            return `
                <div class="suggested-fix mb-2" data-fix-label="Correct scheduled amount" onclick="selectFix(this, 0)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">1</span>
                        <div class="flex-grow-1">
                            <strong>Correct scheduled amount</strong>
                            <p class="mb-1 text-muted small">The recurring charge schedule has the wrong amount. Update it in Entrata.</p>
                            <button class="btn btn-sm btn-suggested-primary mt-1" onclick="applyFix(event, 'Correct scheduled amount', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix mb-2" data-fix-label="Adjust posted transaction" onclick="selectFix(this, 1)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">2</span>
                        <div class="flex-grow-1">
                            <strong>Adjust posted transaction</strong>
                            <p class="mb-1 text-muted small">The posted amount is incorrect. Reverse and repost with correct amount.</p>
                            <button class="btn btn-sm btn-suggested-outline mt-2" onclick="applyFix(event, 'Adjust posted transaction', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix" data-fix-label="Document variance reason" onclick="selectFix(this, 2)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">3</span>
                        <div class="flex-grow-1">
                            <strong>Document variance reason</strong>
                            <p class="mb-1 text-muted small">Amount difference is expected (proration, adjustment, etc.). Document and resolve.</p>
                            <button class="btn btn-sm btn-suggested-outline mt-2" onclick="applyFix(event, 'Document variance reason', 'internal')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        return `
            <div class="text-muted">No suggested fixes available for this exception type.</div>
        `;
    }
    
    function buildSuggestedFixButtons(status) {
        if (status === 'SCHEDULED_NOT_BILLED') {
            return `
                <button class="btn btn-suggested-primary" onclick="applyFixToSelected(event, 'Post missing charge in Entrata', 'external')">
                    Post missing charge in Entrata
                </button>
                <button class="btn btn-suggested-outline" onclick="applyFixToSelected(event, 'Correct schedule dates', 'external')">
                    Correct schedule dates
                </button>
                <button class="btn btn-suggested-outline" onclick="applyFixToSelected(event, 'Mark as expected exception', 'one_time')">
                    Mark as expected exception
                </button>
            `;
        }
        if (status === 'BILLED_NOT_SCHEDULED') {
            return `
                <button class="btn btn-suggested-primary" onclick="applyFixToSelected(event, 'Add recurring charge to schedule', 'external')">
                    Add recurring charge to schedule
                </button>
                <button class="btn btn-suggested-outline" onclick="applyFixToSelected(event, 'Reverse incorrect charge', 'external')">
                    Reverse incorrect charge
                </button>
                <button class="btn btn-suggested-outline" onclick="applyFixToSelected(event, 'Mark as one-time charge', 'one_time')">
                    Mark as one-time charge
                </button>
            `;
        }
        if (status === 'AMOUNT_MISMATCH') {
            return `
                <button class="btn btn-suggested-primary" onclick="applyFixToSelected(event, 'Correct scheduled amount', 'external')">
                    Correct scheduled amount
                </button>
                <button class="btn btn-suggested-outline" onclick="applyFixToSelected(event, 'Adjust posted transaction', 'external')">
                    Adjust posted transaction
                </button>
                <button class="btn btn-suggested-outline" onclick="applyFixToSelected(event, 'Document variance reason', 'internal')">
                    Document variance reason
                </button>
            `;
        }
        return `<div class="text-muted">No suggested fixes available for this exception type.</div>`;
    }

    async function applyFixToSelected(event, fixLabel, actionType) {
        event.stopPropagation();
        
        // Get selected exception rows (exclude already disabled/resolved ones)
        const selectedCheckboxes = document.querySelectorAll('.exception-row-checkbox:checked:not(:disabled)');
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one exception row to apply the fix.');
            return;
        }

        const drawerTitle = document.getElementById('drawerTitle');
        if (!drawerTitle) return;

        const arCodeId = drawerTitle.textContent.split(' - ')[0];
        const resolvedAt = new Date().toISOString();
        
        // Save each selected month to SharePoint individually
        for (const checkbox of selectedCheckboxes) {
            const monthIndex = checkbox.dataset.monthIndex;
            const auditMonth = checkbox.dataset.auditMonth;
            
            // Get month data from the current drawer data
            const monthData = currentDrawerData?.monthly_details?.[monthIndex];
            if (!monthData) continue;
            
            // Prepare month record for SharePoint
            const monthRecord = {
                run_id: '{{ run_id }}',
                property_id: {{ property_id|int }},
                lease_interval_id: {{ lease_interval_id|int }},
                ar_code_id: arCodeId,
                audit_month: auditMonth,
                exception_type: monthData.status_label || monthData.status,
                status: 'Resolved',
                fix_label: fixLabel,
                action_type: actionType,
                variance: monthData.variance || 0,
                expected_total: monthData.expected_total || 0,
                actual_total: monthData.actual_total || 0,
                resolved_at: resolvedAt,
                resolved_by: '{{ user.email if user else "unknown" }}',
                resolved_by_name: '{{ user.name if user else "Unknown" }}',
                exception_count: currentDrawerData?.total_exception_count || currentDrawerData?.exception_count || 0
            };
            
            // Save to SharePoint
            const result = await saveExceptionMonth(monthRecord);
            
            if (result.ok) {
                // Update UI for this month - determine which cell based on exception type
                const isBilledNotScheduled = monthData.status === 'BILLED_NOT_SCHEDULED';
                const fixCell = isBilledNotScheduled 
                    ? document.getElementById(`expectedFix-${monthIndex}`)
                    : document.getElementById(`actualFix-${monthIndex}`);
                
                if (fixCell) {
                    const resolvedInfo = `<br/><small style="font-size: 0.7rem; color: #6c757d;">${formatDateTime(resolvedAt)} by ${currentUserName}</small>`;
                    fixCell.innerHTML = `<span class="badge bg-success">✓</span> ${fixLabel}${resolvedInfo}`;
                }
                
                // Uncheck and disable checkbox (gray it out to show resolved)
                checkbox.checked = false;
                checkbox.disabled = true;
                
                // Mark the entire row as resolved visually
                const row = checkbox.closest('tr');
                if (row) {
                    row.classList.remove('table-danger');
                    row.classList.add('table-secondary');
                    row.style.opacity = '0.6';
                }
            }
        }
    }
    
    function applyFix(event, fixLabel, actionType) {
        event.stopPropagation();
        const drawerTitle = document.getElementById('drawerTitle');
        if (!drawerTitle) return;

        const arCodeId = drawerTitle.textContent.split(' - ')[0];
        const state = exceptionState[String(arCodeId)] || { status: 'Open', fixLabel: null, actionType: null };

        state.status = 'In Progress';
        state.fixLabel = fixLabel;
        state.actionType = actionType;
        if (!state.originalFixLabel) {
            state.originalFixLabel = fixLabel;
        }
        state.updatedFixLabel = fixLabel;
        exceptionState[String(arCodeId)] = state;

        updateWorkflowUI(state);
        updateArCodeStatusBadge(arCodeId, state.status);
        collapseSuggestedFixes();
        persistExceptionState(arCodeId, state);
    }

    function markResolved(event) {
        event.stopPropagation();
        const drawerTitle = document.getElementById('drawerTitle');
        if (!drawerTitle) return;
        const arCodeId = drawerTitle.textContent.split(' - ')[0];
        const state = exceptionState[String(arCodeId)] || { status: 'Open', fixLabel: null, actionType: null };
        state.status = 'Resolved';
        state.resolvedAt = new Date().toISOString();
        exceptionState[String(arCodeId)] = state;
        persistExceptionState(arCodeId, state);
        updateWorkflowUI(state);
        updateArCodeStatusBadge(arCodeId, state.status);
    }

    function updateWorkflowUI(state) {
        const statusMeta = getStatusMeta(state.status);
        const drawerStatusBadge = document.getElementById('drawerStatusBadge');

        if (drawerStatusBadge) {
            drawerStatusBadge.textContent = statusMeta.label;
            drawerStatusBadge.className = `badge bg-${statusMeta.color}`;
        }
    }

    function collapseSuggestedFixes() {
        const container = document.getElementById('suggestedFixes');
        if (!container) return;
        container.classList.add('collapsed');
        container.querySelectorAll('button').forEach(btn => {
            btn.disabled = true;
        });
    }

    function expandSuggestedFixes(event) {
        if (event) event.stopPropagation();
        const container = document.getElementById('suggestedFixes');
        if (!container) return;
        container.classList.remove('collapsed');
        container.querySelectorAll('button').forEach(btn => {
            btn.disabled = false;
        });
    }

    function highlightSelectedFix(fixLabel) {
        if (!fixLabel) return;
        document.querySelectorAll('.suggested-fix').forEach(fix => {
            const label = fix.getAttribute('data-fix-label');
            if (label && label === fixLabel) {
                fix.classList.add('selected');
            }
        });
    }

    function updateArCodeStatusBadge(arCodeId, status) {
        const index = arCodeData.findIndex(item => String(item.ar_code_id) === String(arCodeId));
        if (index === -1) return;
        const badge = document.getElementById(`arStatusBadge-${index}`);
        if (!badge) return;
        const statusMeta = getStatusMeta(status);
        badge.textContent = statusMeta.label === 'Clean' ? 'Clean' : statusMeta.label;
        badge.className = `badge bg-${statusMeta.color} ar-status-badge`;
        badge.removeAttribute('data-pending');
    }

    function persistExceptionState(arCodeId, state) {
        const data = arCodeData.find(item => String(item.ar_code_id) === String(arCodeId));
        if (!data) return;
        const exceptionType = state.exceptionType || ((data.monthly_details || []).find(m => m.status !== 'matched') || {}).status;
        saveExceptionState({
            composite_key: getExceptionKey(data, exceptionType),
            run_id: "{{ run_id }}",
            property_id: {{ property_id|int }},
            lease_interval_id: {{ lease_interval_id|int }},
            ar_code_id: data.ar_code_id,
            exception_type: exceptionType || 'UNKNOWN',
            status: state.status,
            fix_label: state.fixLabel,
            original_fix_label: state.originalFixLabel,
            updated_fix_label: state.updatedFixLabel,
            action_type: state.actionType,
            resolved_at: state.resolvedAt,
            resolved_months: JSON.stringify(state.resolvedMonths || []),
            updated_at: new Date().toISOString(),
            updated_by: "{{ current_user.email if current_user and current_user.email else '' }}"
        });
    }

    // OLD: loadExceptionStates() - No longer needed
    // We now use per-month ExceptionMonths tracking instead of AR-code level ExceptionStates

    async function saveExceptionState(state) {
        try {
            await fetch('/api/exception-states', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(state)
            });
        } catch (err) {
            console.warn('Failed to save exception state', err);
        }
    }

    async function saveExceptionMonth(monthData) {
        /**
         * Save resolution status for a single month.
         * monthData should contain:
         * - run_id, property_id, lease_interval_id, ar_code_id
         * - audit_month (e.g., "2024-01")
         * - status ("Open" or "Resolved")
         * - fix_label, action_type
         * - variance, expected_total, actual_total
         */
        try {
            const response = await fetch('/api/exception-months', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(monthData)
            });
            
            const result = await response.json();
            
            if (result.ok && result.ar_code_status) {
                // Update the AR code row badge with new status
                updateArCodeStatusFromServer(result.ar_code_status);
            }
            
            return result;
        } catch (err) {
            console.error('Failed to save exception month', err);
            return { ok: false, error: err.message };
        }
    }
    
    function updateArCodeStatusFromServer(statusInfo) {
        /**
         * Update AR code row status badge based on server calculation.
         * statusInfo contains: {status, total_months, resolved_months, open_months, status_label}
         */
        const arCodeId = currentArCodeId;
        if (!arCodeId) return;
        
        // Update the table row badge by finding the row
        const row = document.querySelector(`tr[data-ar-code-id="${arCodeId}"]`);
        if (row) {
            const badge = row.querySelector('.ar-status-badge');
            if (badge) {
                // Update badge text and color
                badge.textContent = statusInfo.status_label;
                badge.className = 'badge ar-status-badge bg-' + getStatusBadgeColor(statusInfo.status);
            }
        }
        
        // Update the drawer status badge
        const drawerBadge = document.getElementById('drawerStatusBadge');
        if (drawerBadge) {
            drawerBadge.textContent = statusInfo.status_label;
            drawerBadge.className = 'badge bg-' + getStatusBadgeColor(statusInfo.status);
        }
        
        // Update suggested fixes section based on resolution status
        const suggestedFixesSection = document.querySelector('.suggested-fixes');
        if (suggestedFixesSection) {
            if (statusInfo.status === 'Resolved' && statusInfo.open_months === 0) {
                suggestedFixesSection.classList.add('all-resolved');
                const header = suggestedFixesSection.querySelector('h6');
                if (header && !header.textContent.includes('(All Resolved)')) {
                    header.innerHTML = '<i class="fas fa-lightbulb"></i> Suggested Fixes <span class="text-muted">(All Resolved)</span>';
                }
            } else {
                suggestedFixesSection.classList.remove('all-resolved');
                const header = suggestedFixesSection.querySelector('h6');
                if (header) {
                    header.innerHTML = '<i class="fas fa-lightbulb"></i> Suggested Fixes';
                }
            }
        }
        
        // Update the arCodeData to reflect the new status
        const dataIndex = arCodeData.findIndex(item => String(item.ar_code_id) === String(arCodeId));
        if (dataIndex !== -1) {
            arCodeData[dataIndex].status_label = statusInfo.status_label;
            arCodeData[dataIndex].status_color = getStatusBadgeColor(statusInfo.status);
        }
    }
    
    function getStatusBadgeColor(status) {
        if (status === 'Resolved') return 'success';
        if (status === 'Open') return 'danger';
        if (status === 'Passed') return 'light-success';
        return 'secondary';
    }
    
    function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '-';
        return date.toLocaleString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatDate(dateStr, format) {
        if (!dateStr) return '-';
        
        // Handle date-only strings (YYYY-MM-DD) without timezone conversion
        // Parse manually to avoid UTC interpretation
        if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day); // month is 0-indexed
            
            if (format === 'MMMM YYYY') {
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            } else if (format === 'MM/DD/YYYY') {
                return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
            }
            return date.toLocaleDateString();
        }
        
        // Fallback for other formats
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '-';
        
        if (format === 'MMMM YYYY') {
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        } else if (format === 'MM/DD/YYYY') {
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }
        return date.toLocaleDateString();
    }
    
    function formatNumber(num) {
        if (num === null || num === undefined) return '0';
        return Math.round(num).toLocaleString();
    }
    </script>

    <style>
    .ar-code-row:hover {
        background-color: #f8f9fa;
        transition: background-color 0.2s ease;
    }
    
    .ar-code-row:active {
        background-color: #e9ecef;
    }
    
    .drawer {
        position: fixed;
        top: 0;
        right: -1100px;
        width: 1100px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 1051;
        overflow-y: auto;
    }
    
    .drawer.open {
        right: 0;
    }
    
    
    .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        display: none;
    }
    
    .drawer-overlay.open {
        display: block;
    }
    
    .drawer-content {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .drawer-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
    }
    
    .drawer-body {
        padding: 1.5rem;
        flex: 1;
        overflow-y: auto;
    }
    
    
    .suggested-fix {
        padding: 0.6rem 0.75rem;
        margin-bottom: 0.6rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .suggested-fix:hover {
        border-color: #00a8c8;
        background: #e7f9fd;
    }
    
    .suggested-fix.selected {
        border-color: #00a8c8;
        background: #e7f9fd;
        border-width: 2px;
    }
    
    .suggested-fix .rank-badge {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        border-radius: 50%;
        background: #00a8c8;
        color: white;
        font-weight: bold;
        font-size: 0.875rem;
        margin-right: 0.5rem;
    }

    .btn-suggested-primary {
        background: #ffffff;
        border: 2px solid #0d6efd;
        color: #0d6efd;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-suggested-outline {
        background: #ffffff;
        border: 2px solid #0d6efd;
        color: #0d6efd;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-suggested-primary:hover,
    .btn-suggested-outline:hover {
        background: #0d6efd;
        border-color: #0d6efd;
        color: #ffffff;
    }

    .suggested-fixes.all-resolved .suggested-fix {
        opacity: 0.5;
        pointer-events: none;
    }

    .suggested-fixes.all-resolved .btn-suggested-primary,
    .suggested-fixes.all-resolved .btn-suggested-outline {
        background: #e9ecef;
        border-color: #dee2e6;
        color: #6c757d;
        cursor: not-allowed;
    }

    .exception-row-checkbox:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        accent-color: #198754;
    }
    
    .table-danger:has(.exception-row-checkbox:disabled) {
        background-color: #f8f9fa;
        opacity: 0.7;
    }
    
    .table-danger:has(.exception-row-checkbox:disabled) td {
        color: #6c757d;
    }

    .ar-status-badge[data-pending="true"] {
        opacity: 0;
    }

    .suggested-fixes.collapsed .suggested-fix {
        opacity: 0.45;
    }

    .suggested-fixes.collapsed .suggested-fix.selected {
        opacity: 0.9;
    }

    .suggested-fixes.collapsed .suggested-fix:not(.selected) {
        display: none;
    }

    .bg-light-success {
        background-color: #d4edda !important;
        color: #155724 !important;
    }

    .workflow-fix-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: #eef6ff;
        border: 1px solid #cfe2ff;
        color: #0b5ed7;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        font-size: 0.75rem;
        margin-top: 0.5rem;
    }
    </style>
    
    <!-- Lease Metadata -->
    <div class="row mt-3 mb-4">
        <div class="col-12">
            <p class="text-muted small">
                {% if property_name %}
                    Property: <strong>{{ property_name }}</strong> (ID: {{ property_id|int }})
                {% else %}
                    Property ID: <code>{{ property_id|int }}</code>
                {% endif %}
                {% if metadata.audit_period %}
                | <strong>Audit Period: 
                {% if metadata.audit_period.month %}
                    {{ ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][metadata.audit_period.month] }}
                {% endif %}
                {% if metadata.audit_period.year %}
                    {{ metadata.audit_period.year }}
                {% endif %}
                </strong>
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% endblock %}
