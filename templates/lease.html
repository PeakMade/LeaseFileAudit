{% extends "base.html" %}

{% block title %}Lease {{ lease_interval_id|int }} - Lease Audit{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            {% if customer_name %}
                <h2>{{ customer_name }} <span style="font-size: 0.7em; color: #6c757d;">(Lease Interval Id: {{ lease_interval_id|int }})</span></h2>
            {% else %}
                <h2>Lease Interval ID: {{ lease_interval_id|int }}</h2>
            {% endif %}
        </div>
        <div class="col-auto">
            {% if has_customer_id %}
            <a href="{{ entrata_url }}" target="_blank" class="btn btn-primary me-2" title="Open resident profile in Entrata (Customer ID: {{ customer_id }})">
                <i class="fas fa-external-link-alt"></i> Open in Entrata
            </a>
            {% else %}
            <button class="btn btn-primary me-2" disabled title="Customer ID not available - button disabled">
                <i class="fas fa-external-link-alt"></i> Open in Entrata
            </button>
            {% endif %}
            <a href="{{ url_for('main.property_view', property_id=property_id, run_id=run_id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Property
            </a>
        </div>
    </div>

    <!-- Summary Banner -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-light border" role="alert">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Total Undercharge:</strong> <span style="color: #c20068;">${{ "{:,.0f}".format(total_undercharge) }}</span>
                        <span class="ms-4"><strong>Total Overcharge:</strong> <span style="color: #00a8c8;">${{ "{:,.0f}".format(total_overcharge) }}</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified AR Codes Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">AR Code Details</h5>
                </div>
                <div class="card-body p-0">
                    {% if all_ar_codes %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 120px;">AR Code</th>
                                    <th>AR Code Name</th>
                                    <th class="text-center" style="width: 120px;">Matched</th>
                                    <th class="text-center" style="width: 120px;">Exceptions</th>
                                    <th class="text-center" style="width: 180px;">Status</th>
                                    <th class="text-center" style="width: 80px;">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ar_code in all_ar_codes %}
                                <tr>
                                    <td><strong>{{ ar_code.ar_code_id|int }}</strong></td>
                                    <td>{{ ar_code.ar_code_name if ar_code.ar_code_name else '-' }}</td>
                                    <td class="text-center">
                                        {% if ar_code.matched_count > 0 %}
                                        <span class="badge bg-success">{{ ar_code.matched_count }}</span>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if ar_code.exception_count > 0 %}
                                        <span class="badge bg-danger">{{ ar_code.exception_count }}</span>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-{{ ar_code.status_color }} ar-status-badge" id="arStatusBadge-{{ loop.index0 }}" data-pending="true">{{ ar_code.status_label }}</span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                onclick="openDrawer({{ loop.index0 }})"
                                                title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <div class="alert alert-success m-3" role="alert">
                            <h5><i class="fas fa-check-circle"></i> Clean Audit - No Charges Found</h5>
                            <p class="mb-0">No AR codes found for this lease.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Side Drawer for AR Code Details -->
    <div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawer()"></div>
    <div id="detailsDrawer" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h5 class="mb-0" id="drawerTitle">AR Code Details</h5>
                <button type="button" class="btn-close" onclick="closeDrawer()"></button>
            </div>
            <div class="drawer-body" id="drawerBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Hidden data for drawer content -->
    <script>
    const arCodeData = {{ all_ar_codes|tojson|safe }};
    const exceptionState = {};
    const hasCustomerId = {{ 'true' if has_customer_id else 'false' }};

    function getExceptionKey(data, exceptionType) {
        return `{{ run_id }}:{{ property_id }}:{{ lease_interval_id }}:${data.ar_code_id}:${exceptionType || 'UNKNOWN'}`;
    }

    function normalizeWorkflowStatus(status) {
        if (!status) return 'Open';
        const normalized = String(status).trim().toLowerCase();
        if (normalized === 'resolved') return 'Resolved';
        if (normalized === 'open') return 'Open';
        // Treat any old "in progress" as open
        if (normalized === 'in progress' || normalized === 'in_progress') return 'Open';
        return status;
    }

    function getStatusMeta(status) {
        const normalized = normalizeWorkflowStatus(status);
        if (normalized === 'Resolved') return { label: 'Resolved', color: 'success' };
        if (normalized === 'Open') return { label: 'Open', color: 'danger' };
        return { label: 'Clean', color: 'success' };
    }

    function getOrInitState(data) {
        const key = String(data.ar_code_id);
        if (!exceptionState[key]) {
            const hasExceptions = data.exception_count > 0;
            const exception = (data.monthly_details || []).find(m => m.status !== 'matched');
            const exceptionType = exception ? exception.status : null;
            const storedState = exceptionState[key] || null;
            exceptionState[key] = {
                status: storedState?.status || (hasExceptions ? 'Open' : 'Clean'),
                fixLabel: storedState?.fixLabel || null,
                actionType: storedState?.actionType || null,
                resolvedAt: storedState?.resolvedAt || null,
                exceptionType: exceptionType,
                originalFixLabel: storedState?.originalFixLabel || storedState?.fixLabel || null,
                updatedFixLabel: storedState?.updatedFixLabel || storedState?.fixLabel || null
            };
        }
        return exceptionState[key];
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadExceptionStates().finally(() => {
            arCodeData.forEach(data => {
                const state = getOrInitState(data);
                if (state.status) {
                    updateArCodeStatusBadge(data.ar_code_id, state.status);
                }
            });
        });
    });
    
    function openDrawer(index) {
        const data = arCodeData[index];
        const state = getOrInitState(data);
        const drawer = document.getElementById('detailsDrawer');
        const title = document.getElementById('drawerTitle');
        const body = document.getElementById('drawerBody');
        const statusMeta = getStatusMeta(state.status);
        const hasSelectionChanged = !!(state.originalFixLabel && state.updatedFixLabel && state.originalFixLabel !== state.updatedFixLabel);
        
        title.textContent = `${data.ar_code_id} - ${data.ar_code_name || 'Unknown'}`;
        
        // Build drawer content
        let content = '<div class="mb-3">';
        content += `<div class="d-flex gap-2 mb-3 align-items-center">`;
        if (data.matched_count > 0) {
            content += `<span class="badge bg-success">${data.matched_count} Matched</span>`;
        }
        if (data.exception_count > 0) {
            content += `<span class="badge bg-danger">${data.exception_count} Exception(s)</span>`;
        }
        content += `<span class="badge bg-${statusMeta.color}" id="drawerStatusBadge">${statusMeta.label}</span>`;
        content += '</div>';

        // Exception Workflow section - moved to top
        if (data.exception_count > 0) {
            const exception = (data.monthly_details || []).find(m => m.status !== 'matched');
            const status = exception ? exception.status : null;
            const statusLabel = exception ? exception.status_label : 'Exception';

            const nextStep = state.status === 'Resolved'
                ? 'Complete'
                : state.actionType === 'external'
                    ? 'Complete in Entrata'
                    : state.actionType === 'internal'
                        ? 'Flag for admin/ops'
                        : state.actionType === 'one_time'
                            ? 'No further action'
                            : 'Complete in Entrata';

            const showTracker = state.fixLabel ? '' : 'd-none';
            const showOpenEntrata = state.actionType === 'external' ? '' : 'd-none';
            const originalFixRow = hasSelectionChanged ? '' : 'd-none';
            const updatedFixRow = hasSelectionChanged ? '' : 'd-none';

            const openEntrataMarkup = hasCustomerId
                ? `<a href="{{ entrata_url }}" target="_blank" class="btn btn-sm btn-outline-primary ${showOpenEntrata}" id="openEntrataBtn">
                    <i class="fas fa-external-link-alt"></i> Open in Entrata
                   </a>`
                : `<button class="btn btn-sm btn-outline-primary ${showOpenEntrata}" id="openEntrataBtn" disabled title="Customer ID not available - button disabled">
                    <i class="fas fa-external-link-alt"></i> Open in Entrata
                   </button>`;

            content += `
                <h5 class="mb-3"><i class="fas fa-tasks"></i> Exception Workflow</h5>
                <p class="text-muted mb-3"><strong>${statusLabel}</strong> detected across ${data.exception_count} month${data.exception_count > 1 ? 's' : ''}</p>
                <div class="card mb-3 border-light ${showTracker}" id="resolutionTracker">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="text-uppercase text-muted small">Resolution Summary</div>
                            <span class="badge bg-${statusMeta.color}" id="trackerStatus">${state.status}</span>
                        </div>
                        <div class="mb-2"><strong>Fix Applied:</strong> <span id="trackerFix">${state.fixLabel || '-'}</span></div>
                        <div class="mb-2 ${originalFixRow}" id="trackerOriginalRow"><strong>Original Fix:</strong> <span id="trackerOriginal">${state.originalFixLabel || '-'}</span></div>
                        <div class="mb-2 ${updatedFixRow}" id="trackerUpdatedRow"><strong>Updated Fix:</strong> <span id="trackerUpdated">${state.updatedFixLabel || '-'}</span></div>
                        <div class="mb-2"><strong>Resolved On:</strong> <span id="trackerResolved">${state.resolvedAt ? formatDateTime(state.resolvedAt) : '-'}</span></div>
                        <div class="d-flex gap-2">
                            ${openEntrataMarkup}
                        </div>
                    </div>
                </div>
            `;
        }
        
        content += '</div>';
        
        // Monthly details table
        content += '<table class="table table-sm table-bordered">';
        content += '<thead class="table-secondary">';
        content += '<tr>';
        content += '<th style="width: 30px;"></th>';
        content += '<th class="align-middle">Month</th>';
        content += '<th colspan="2" class="text-center text-info">Expected</th>';
        content += '<th colspan="2" class="text-center text-primary">Actual</th>';
        content += '</tr>';
        content += '<tr>';
        content += '<th></th>';
        content += '<th></th>';
        content += '<th class="text-info">Period</th>';
        content += '<th class="text-end text-info">Amount</th>';
        content += '<th class="text-primary">Post Date</th>';
        content += '<th class="text-end text-primary">Amount</th>';
        content += '</tr>';
        content += '</thead>';
        content += '<tbody>';
        
        // Add monthly rows
        if (data.monthly_details && data.monthly_details.length > 0) {
            data.monthly_details.forEach((month, monthIndex) => {
                const expTrans = month.expected_transactions || [];
                const actTrans = month.actual_transactions || [];
                const maxRows = Math.max(expTrans.length, actTrans.length, 1);
                const isException = month.status !== 'matched';
                const rowClass = isException ? 'table-danger' : '';
                
                for (let i = 0; i < maxRows; i++) {
                    content += `<tr class="${rowClass}">`;
                    
                    // Checkbox column (only first row and only for exceptions)
                    if (i === 0) {
                        if (isException) {
                            content += `<td rowspan="${maxRows}" class="align-middle text-center">
                                <input type="checkbox" class="form-check-input exception-row-checkbox" data-month-index="${monthIndex}" data-audit-month="${month.audit_month}">
                            </td>`;
                        } else {
                            content += `<td rowspan="${maxRows}"></td>`;
                        }
                    }
                    
                    // Month column (only first row)
                    if (i === 0) {
                        let monthLabel = formatDate(month.audit_month, 'MMMM YYYY');
                        if (isException) {
                            monthLabel += ` <span class="badge bg-${month.status_color}">${month.status_label}</span>`;
                        }
                        content += `<td rowspan="${maxRows}" class="align-middle"><strong>${monthLabel}</strong></td>`;
                    }
                    
                    // Expected columns
                    if (i < expTrans.length) {
                        const exp = expTrans[i];
                        content += `<td><small>${formatDate(exp.period_start, 'MM/DD/YYYY')} - ${formatDate(exp.period_end, 'MM/DD/YYYY')}</small></td>`;
                        content += `<td class="text-end">$${formatNumber(exp.amount)}</td>`;
                    } else {
                        content += '<td colspan="2" class="text-muted text-center"><em>No scheduled charges</em></td>';
                    }
                    
                    // Actual columns
                    if (i < actTrans.length) {
                        const act = actTrans[i];
                        content += `<td>${formatDate(act.post_date, 'MM/DD/YYYY')}</td>`;
                        content += `<td class="text-end">$${formatNumber(act.amount)}</td>`;
                    } else {
                        content += '<td colspan="2" class="text-muted text-center"><em>No actual transactions</em></td>';
                    }
                    
                    content += '</tr>';
                }
            });
        } else {
            content += '<tr><td colspan="6" class="text-center text-muted">No monthly details available</td></tr>';
        }
        
        content += '</tbody>';
        content += '</table>';

        // Suggested fixes as horizontal buttons below table
        if (data.exception_count > 0) {
            const exception = (data.monthly_details || []).find(m => m.status !== 'matched');
            const status = exception ? exception.status : null;
            
            content += `
                <div class="mb-3">
                    <h6 class="mb-2"><i class="fas fa-lightbulb"></i> Suggested Fixes</h6>
                    <div class="d-flex gap-2 flex-wrap" id="suggestedFixButtons">
                        ${buildSuggestedFixButtons(status)}
                    </div>
                </div>
            `;
        }
        
        body.innerHTML = content;
        drawer.classList.add('open');
        document.getElementById('drawerOverlay').classList.add('open');
    }
    
    function closeDrawer() {
        document.getElementById('detailsDrawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('open');
    }
    
    // Exceptions workflow drawer functions
    function selectFix(element, fixIndex) {
        // Remove selected class from all fixes
        document.querySelectorAll('.suggested-fix').forEach(fix => {
            fix.classList.remove('selected');
        });
        // Add selected class to clicked fix
        element.classList.add('selected');
    }

    function buildSuggestedFixes(status) {
        if (status === 'SCHEDULED_NOT_BILLED') {
            return `
                <div class="suggested-fix mb-2" data-fix-label="Post missing charge in Entrata" onclick="selectFix(this, 0)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">1</span>
                        <div class="flex-grow-1">
                            <strong>Post missing charge in Entrata</strong>
                            <p class="mb-1 text-muted small">The scheduled charge exists but was never billed. Post the AR transaction in Entrata.</p>
                            <button class="btn btn-sm btn-suggested-primary mt-1" onclick="applyFix(event, 'Post missing charge in Entrata', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix mb-2" data-fix-label="Correct schedule dates" onclick="selectFix(this, 1)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">2</span>
                        <div class="flex-grow-1">
                            <strong>Correct schedule dates</strong>
                            <p class="mb-1 text-muted small">The schedule may have incorrect start/end dates. Review and adjust the recurring charge schedule.</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="applyFix(event, 'Correct schedule dates', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix" data-fix-label="Mark as expected exception" onclick="selectFix(this, 2)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">3</span>
                        <div class="flex-grow-1">
                            <strong>Mark as expected exception</strong>
                            <p class="mb-1 text-muted small">This may be expected (move-out, MTM, concession, etc.). Document the reason and mark as resolved.</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="applyFix(event, 'Mark as expected exception', 'one_time')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        if (status === 'BILLED_NOT_SCHEDULED') {
            return `
                <div class="suggested-fix mb-2" data-fix-label="Add recurring charge to schedule" onclick="selectFix(this, 0)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">1</span>
                        <div class="flex-grow-1">
                            <strong>Add recurring charge to schedule</strong>
                            <p class="mb-1 text-muted small">A charge was billed but no schedule exists. Create or update the recurring charge in Entrata.</p>
                            <button class="btn btn-sm btn-suggested-primary mt-1" onclick="applyFix(event, 'Add recurring charge to schedule', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix mb-2" data-fix-label="Reverse incorrect charge" onclick="selectFix(this, 1)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">2</span>
                        <div class="flex-grow-1">
                            <strong>Reverse incorrect charge</strong>
                            <p class="mb-1 text-muted small">The charge was posted in error. Reverse the transaction in Entrata.</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="applyFix(event, 'Reverse incorrect charge', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix" data-fix-label="Mark as one-time charge" onclick="selectFix(this, 2)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">3</span>
                        <div class="flex-grow-1">
                            <strong>Mark as one-time charge</strong>
                            <p class="mb-1 text-muted small">This is a legitimate one-time charge. Document and mark as resolved.</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="applyFix(event, 'Mark as one-time charge', 'one_time')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        if (status === 'AMOUNT_MISMATCH') {
            return `
                <div class="suggested-fix mb-2" data-fix-label="Correct scheduled amount" onclick="selectFix(this, 0)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">1</span>
                        <div class="flex-grow-1">
                            <strong>Correct scheduled amount</strong>
                            <p class="mb-1 text-muted small">The recurring charge schedule has the wrong amount. Update it in Entrata.</p>
                            <button class="btn btn-sm btn-suggested-primary mt-1" onclick="applyFix(event, 'Correct scheduled amount', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix mb-2" data-fix-label="Adjust posted transaction" onclick="selectFix(this, 1)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">2</span>
                        <div class="flex-grow-1">
                            <strong>Adjust posted transaction</strong>
                            <p class="mb-1 text-muted small">The posted amount is incorrect. Reverse and repost with correct amount.</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="applyFix(event, 'Adjust posted transaction', 'external')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
                <div class="suggested-fix" data-fix-label="Document variance reason" onclick="selectFix(this, 2)">
                    <div class="d-flex align-items-start">
                        <span class="rank-badge">3</span>
                        <div class="flex-grow-1">
                            <strong>Document variance reason</strong>
                            <p class="mb-1 text-muted small">Amount difference is expected (proration, adjustment, etc.). Document and resolve.</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="applyFix(event, 'Document variance reason', 'internal')">
                                <i class="fas fa-check"></i> Apply as Plan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        return `
            <div class="text-muted">No suggested fixes available for this exception type.</div>
        `;
    }
    
    function buildSuggestedFixButtons(status) {
        if (status === 'SCHEDULED_NOT_BILLED') {
            return `
                <button class="btn btn-primary" onclick="applyFixToSelected(event, 'Post missing charge in Entrata', 'external')">
                    Post missing charge in Entrata
                </button>
                <button class="btn btn-outline-primary" onclick="applyFixToSelected(event, 'Correct schedule dates', 'external')">
                    Correct schedule dates
                </button>
                <button class="btn btn-outline-primary" onclick="applyFixToSelected(event, 'Mark as expected exception', 'one_time')">
                    Mark as expected exception
                </button>
            `;
        }
        if (status === 'BILLED_NOT_SCHEDULED') {
            return `
                <button class="btn btn-primary" onclick="applyFixToSelected(event, 'Add recurring charge to schedule', 'external')">
                    Add recurring charge to schedule
                </button>
                <button class="btn btn-outline-primary" onclick="applyFixToSelected(event, 'Reverse incorrect charge', 'external')">
                    Reverse incorrect charge
                </button>
                <button class="btn btn-outline-primary" onclick="applyFixToSelected(event, 'Mark as one-time charge', 'one_time')">
                    Mark as one-time charge
                </button>
            `;
        }
        if (status === 'AMOUNT_MISMATCH') {
            return `
                <button class="btn btn-primary" onclick="applyFixToSelected(event, 'Correct scheduled amount', 'external')">
                    Correct scheduled amount
                </button>
                <button class="btn btn-outline-primary" onclick="applyFixToSelected(event, 'Adjust posted transaction', 'external')">
                    Adjust posted transaction
                </button>
                <button class="btn btn-outline-primary" onclick="applyFixToSelected(event, 'Document variance reason', 'internal')">
                    Document variance reason
                </button>
            `;
        }
        return `<div class="text-muted">No suggested fixes available for this exception type.</div>`;
    }

    function applyFixToSelected(event, fixLabel, actionType) {
        event.stopPropagation();
        
        // Get selected exception rows
        const selectedCheckboxes = document.querySelectorAll('.exception-row-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one exception row to apply the fix.');
            return;
        }

        const drawerTitle = document.getElementById('drawerTitle');
        if (!drawerTitle) return;

        const arCodeId = drawerTitle.textContent.split(' - ')[0];
        const state = exceptionState[String(arCodeId)] || { status: 'Open', fixLabel: null, actionType: null };

        state.status = 'Resolved';
        state.fixLabel = fixLabel;
        state.actionType = actionType;
        state.resolvedAt = new Date().toISOString();
        if (!state.originalFixLabel) {
            state.originalFixLabel = fixLabel;
        }
        state.updatedFixLabel = fixLabel;
        exceptionState[String(arCodeId)] = state;

        updateWorkflowUI(state);
        updateArCodeStatusBadge(arCodeId, state.status);
        persistExceptionState(arCodeId, state);
        
        // Show the resolution tracker
        const tracker = document.getElementById('resolutionTracker');
        if (tracker) {
            tracker.classList.remove('d-none');
        }
    }
    
    function applyFix(event, fixLabel, actionType) {
        event.stopPropagation();
        const drawerTitle = document.getElementById('drawerTitle');
        if (!drawerTitle) return;

        const arCodeId = drawerTitle.textContent.split(' - ')[0];
        const state = exceptionState[String(arCodeId)] || { status: 'Open', fixLabel: null, actionType: null };

        state.status = 'In Progress';
        state.fixLabel = fixLabel;
        state.actionType = actionType;
        if (!state.originalFixLabel) {
            state.originalFixLabel = fixLabel;
        }
        state.updatedFixLabel = fixLabel;
        exceptionState[String(arCodeId)] = state;

        updateWorkflowUI(state);
        updateArCodeStatusBadge(arCodeId, state.status);
        collapseSuggestedFixes();
        persistExceptionState(arCodeId, state);
    }

    function markResolved(event) {
        event.stopPropagation();
        const drawerTitle = document.getElementById('drawerTitle');
        if (!drawerTitle) return;
        const arCodeId = drawerTitle.textContent.split(' - ')[0];
        const state = exceptionState[String(arCodeId)] || { status: 'Open', fixLabel: null, actionType: null };
        state.status = 'Resolved';
        state.resolvedAt = new Date().toISOString();
        exceptionState[String(arCodeId)] = state;
        persistExceptionState(arCodeId, state);
        updateWorkflowUI(state);
        updateArCodeStatusBadge(arCodeId, state.status);
    }

    function updateWorkflowUI(state) {
        const statusMeta = getStatusMeta(state.status);
        const statusEl = document.getElementById('workflowStatus');
        const drawerStatusBadge = document.getElementById('drawerStatusBadge');
        const tracker = document.getElementById('resolutionTracker');
        const trackerStatus = document.getElementById('trackerStatus');
        const trackerFix = document.getElementById('trackerFix');
        const trackerOriginal = document.getElementById('trackerOriginal');
        const trackerUpdated = document.getElementById('trackerUpdated');
        const trackerOriginalRow = document.getElementById('trackerOriginalRow');
        const trackerUpdatedRow = document.getElementById('trackerUpdatedRow');
        const trackerNext = document.getElementById('trackerNext');
        const trackerResolved = document.getElementById('trackerResolved');
        const trackerResolvedRow = document.getElementById('trackerResolvedRow');
        const openEntrataBtn = document.getElementById('openEntrataBtn');
        const changeFixRow = document.getElementById('changeFixRow');

        if (statusEl) statusEl.textContent = state.status;
        if (drawerStatusBadge) {
            drawerStatusBadge.textContent = statusMeta.label;
            drawerStatusBadge.className = `badge bg-${statusMeta.color}`;
        }

        if (tracker) {
            tracker.classList.remove('d-none');
        }
        if (trackerStatus) {
            trackerStatus.textContent = statusMeta.label;
            trackerStatus.className = `badge bg-${statusMeta.color}`;
        }
        if (trackerFix) trackerFix.textContent = state.fixLabel || '-';

        const hasSelectionChanged = !!(state.originalFixLabel && state.updatedFixLabel && state.originalFixLabel !== state.updatedFixLabel);
        if (trackerOriginal) trackerOriginal.textContent = state.originalFixLabel || '-';
        if (trackerUpdated) trackerUpdated.textContent = state.updatedFixLabel || '-';
        if (trackerOriginalRow) {
            trackerOriginalRow.classList.toggle('d-none', !hasSelectionChanged);
        }
        if (trackerUpdatedRow) {
            trackerUpdatedRow.classList.toggle('d-none', !hasSelectionChanged);
        }

        const nextStep = state.status === 'Resolved'
            ? 'Complete'
            : state.actionType === 'external'
                ? 'Complete in Entrata'
                : state.actionType === 'internal'
                    ? 'Flag for admin/ops'
                    : state.actionType === 'one_time'
                        ? 'No further action'
                        : 'Complete in Entrata';
        if (trackerNext) trackerNext.textContent = nextStep;

        if (trackerResolved) {
            if (state.resolvedAt) {
                trackerResolved.textContent = formatDateTime(state.resolvedAt);
                if (trackerResolvedRow) trackerResolvedRow.classList.remove('d-none');
            } else {
                trackerResolved.textContent = '-';
                if (trackerResolvedRow) trackerResolvedRow.classList.add('d-none');
            }
        }

        if (openEntrataBtn) {
            if (state.actionType === 'external' && state.status !== 'Resolved') {
                openEntrataBtn.classList.remove('d-none');
            } else {
                openEntrataBtn.classList.add('d-none');
            }
        }

        if (changeFixRow) {
            changeFixRow.classList.toggle('d-none', !state.fixLabel);
        }

        const alertBox = document.querySelector('.alert.alert-warning');
        if (alertBox) {
            const existingBadge = alertBox.querySelector('.workflow-fix-badge');
            if (state.fixLabel) {
                const badge = existingBadge || document.createElement('div');
                badge.className = 'workflow-fix-badge';
                badge.textContent = `âœ… ${state.status} Fix: ${state.fixLabel}`;
                if (!existingBadge) {
                    alertBox.appendChild(badge);
                }
            } else if (existingBadge) {
                existingBadge.remove();
            }
        }

        if (state.fixLabel) {
            collapseSuggestedFixes();
        }
    }

    function collapseSuggestedFixes() {
        const container = document.getElementById('suggestedFixes');
        if (!container) return;
        container.classList.add('collapsed');
        container.querySelectorAll('button').forEach(btn => {
            btn.disabled = true;
        });
    }

    function expandSuggestedFixes(event) {
        if (event) event.stopPropagation();
        const container = document.getElementById('suggestedFixes');
        if (!container) return;
        container.classList.remove('collapsed');
        container.querySelectorAll('button').forEach(btn => {
            btn.disabled = false;
        });
    }

    function highlightSelectedFix(fixLabel) {
        if (!fixLabel) return;
        document.querySelectorAll('.suggested-fix').forEach(fix => {
            const label = fix.getAttribute('data-fix-label');
            if (label && label === fixLabel) {
                fix.classList.add('selected');
            }
        });
    }

    function updateArCodeStatusBadge(arCodeId, status) {
        const index = arCodeData.findIndex(item => String(item.ar_code_id) === String(arCodeId));
        if (index === -1) return;
        const badge = document.getElementById(`arStatusBadge-${index}`);
        if (!badge) return;
        const statusMeta = getStatusMeta(status);
        badge.textContent = statusMeta.label === 'Clean' ? 'Clean' : statusMeta.label;
        badge.className = `badge bg-${statusMeta.color} ar-status-badge`;
        badge.removeAttribute('data-pending');
    }

    function persistExceptionState(arCodeId, state) {
        const data = arCodeData.find(item => String(item.ar_code_id) === String(arCodeId));
        if (!data) return;
        const exceptionType = state.exceptionType || ((data.monthly_details || []).find(m => m.status !== 'matched') || {}).status;
        saveExceptionState({
            composite_key: getExceptionKey(data, exceptionType),
            run_id: "{{ run_id }}",
            property_id: {{ property_id|int }},
            lease_interval_id: {{ lease_interval_id|int }},
            ar_code_id: data.ar_code_id,
            exception_type: exceptionType || 'UNKNOWN',
            status: state.status,
            fix_label: state.fixLabel,
            original_fix_label: state.originalFixLabel,
            updated_fix_label: state.updatedFixLabel,
            action_type: state.actionType,
            resolved_at: state.resolvedAt,
            updated_at: new Date().toISOString(),
            updated_by: "{{ current_user.email if current_user and current_user.email else '' }}"
        });
    }

    async function loadExceptionStates() {
        try {
            const response = await fetch(`/api/exception-states/{{ run_id }}/{{ property_id|int }}/{{ lease_interval_id|int }}`);
            if (!response.ok) return;
            const data = await response.json();
            (data.states || []).forEach(item => {
                if (!item.ar_code_id) return;
                exceptionState[String(item.ar_code_id)] = {
                    status: normalizeWorkflowStatus(item.status || 'Open'),
                    fixLabel: item.fix_label || null,
                    originalFixLabel: item.original_fix_label || item.fix_label || null,
                    updatedFixLabel: item.updated_fix_label || item.fix_label || null,
                    actionType: item.action_type || null,
                    resolvedAt: item.resolved_at || null,
                    exceptionType: item.exception_type || null
                };
            });
        } catch (err) {
            console.warn('Failed to load exception states', err);
        }
    }

    async function saveExceptionState(state) {
        try {
            await fetch('/api/exception-states', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(state)
            });
        } catch (err) {
            console.warn('Failed to save exception state', err);
        }
    }
    
    function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '-';
        return date.toLocaleString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatDate(dateStr, format) {
        if (!dateStr) return '-';
        
        // Handle date-only strings (YYYY-MM-DD) without timezone conversion
        // Parse manually to avoid UTC interpretation
        if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day); // month is 0-indexed
            
            if (format === 'MMMM YYYY') {
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            } else if (format === 'MM/DD/YYYY') {
                return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
            }
            return date.toLocaleDateString();
        }
        
        // Fallback for other formats
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '-';
        
        if (format === 'MMMM YYYY') {
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        } else if (format === 'MM/DD/YYYY') {
            return date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }
        return date.toLocaleDateString();
    }
    
    function formatNumber(num) {
        if (num === null || num === undefined) return '0';
        return Math.round(num).toLocaleString();
    }
    </script>

    <style>
    .drawer {
        position: fixed;
        top: 0;
        right: -800px;
        width: 800px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 1051;
        overflow-y: auto;
    }
    
    .drawer.open {
        right: 0;
    }
    
    
    .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        display: none;
    }
    
    .drawer-overlay.open {
        display: block;
    }
    
    .drawer-content {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .drawer-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
    }
    
    .drawer-body {
        padding: 1.5rem;
        flex: 1;
        overflow-y: auto;
    }
    
    
    .suggested-fix {
        padding: 0.6rem 0.75rem;
        margin-bottom: 0.6rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .suggested-fix:hover {
        border-color: #00a8c8;
        background: #e7f9fd;
    }
    
    .suggested-fix.selected {
        border-color: #00a8c8;
        background: #e7f9fd;
        border-width: 2px;
    }
    
    .suggested-fix .rank-badge {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        border-radius: 50%;
        background: #00a8c8;
        color: white;
        font-weight: bold;
        font-size: 0.875rem;
        margin-right: 0.5rem;
    }

    .btn-suggested-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
        font-weight: 700;
    }

    .btn-suggested-primary:hover {
        background-color: #0b5ed7;
        border-color: #0b5ed7;
        color: #fff;
    }

    .ar-status-badge[data-pending="true"] {
        opacity: 0;
    }

    .suggested-fixes.collapsed .suggested-fix {
        opacity: 0.45;
    }

    .suggested-fixes.collapsed .suggested-fix.selected {
        opacity: 0.9;
    }

    .suggested-fixes.collapsed .suggested-fix:not(.selected) {
        display: none;
    }

    .workflow-fix-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: #eef6ff;
        border: 1px solid #cfe2ff;
        color: #0b5ed7;
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        font-size: 0.75rem;
        margin-top: 0.5rem;
    }
    </style>
    
    <!-- Lease Metadata -->
    <div class="row mt-3 mb-4">
        <div class="col-12">
            <p class="text-muted small">
                {% if property_name %}
                    Property: <strong>{{ property_name }}</strong> (ID: {{ property_id|int }})
                {% else %}
                    Property ID: <code>{{ property_id|int }}</code>
                {% endif %}
                {% if metadata.audit_period %}
                | <strong>Audit Period: 
                {% if metadata.audit_period.month %}
                    {{ ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][metadata.audit_period.month] }}
                {% endif %}
                {% if metadata.audit_period.year %}
                    {{ metadata.audit_period.year }}
                {% endif %}
                </strong>
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% endblock %}
