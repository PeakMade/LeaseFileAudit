{% extends "base.html" %}

{% block title %}Portfolio Overview - Lease Audit{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2>PeakMade Portfolio</h2>
        </div>
    </div>

    <!-- Overall Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h6 class="text-muted mb-2">Current Undercharge</h6>
                            <h3 class="mb-0" style="color: #c20068;">${{ "{:,.0f}".format(kpis.current_undercharge) }}</h3>
                            <small class="text-muted">Historical: ${{ "{:,.0f}".format(kpis.historical_undercharge) }}</small>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted mb-2">Current Overcharge</h6>
                            <h3 class="mb-0" style="color: #00a8c8;">${{ "{:,.0f}".format(kpis.current_overcharge) }}</h3>
                            <small class="text-muted">Historical: ${{ "{:,.0f}".format(kpis.historical_overcharge) }}</small>
                        </div>
                        <div class="col-md-2">
                            <h6 class="text-muted mb-2">Money Recovered</h6>
                            <h3 class="mb-0" style="color: #ff6600;">${{ "{:,.0f}".format(kpis.money_recovered) }}</h3>
                            <small class="text-muted">Exceptions Fixed</small>
                        </div>
                        <div class="col-md-2">
                            <h6 class="text-muted mb-2">Total Variance</h6>
                            <h3 class="mb-0">${{ "{:,.0f}".format(kpis.current_variance) }}</h3>
                            <small class="text-muted">Current Net</small>
                        </div>
                        <div class="col-md-2">
                            <h6 class="text-muted mb-2">Open Exceptions</h6>
                            <h3 class="mb-0" style="color: #ff6600;">{{ kpis.open_exceptions }}</h3>
                            <small class="text-muted">Match Rate: {{ "%.1f"|format(kpis.match_rate) }}%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Summary Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Properties</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="propertiesTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="property_name" style="cursor: pointer; min-width: 300px;">
                                        <div class="d-flex align-items-center gap-2">
                                            <span onclick="event.stopPropagation(); sortByPropertyName();" style="cursor: pointer;">
                                                Property Name <i class="fas fa-sort-up text-muted" id="propertyNameSortIcon"></i>
                                            </span>
                                            <div class="input-group input-group-sm" style="max-width: 200px;" onclick="event.stopPropagation();">
                                                <input type="text" 
                                                       class="form-control form-control-sm" 
                                                       id="propertySearch" 
                                                       list="propertyNames"
                                                       placeholder="Filter..."
                                                       autocomplete="off"
                                                       style="font-size: 0.875rem;">
                                                <datalist id="propertyNames">
                                                    {% for property in properties %}
                                                    <option value="{{ property.property_name if property.property_name else '-' }}">
                                                    {% endfor %}
                                                </datalist>
                                                <button class="btn btn-outline-secondary btn-sm" type="button" id="clearSearch" style="padding: 0.25rem 0.5rem;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </th>
                                    <th>Property ID</th>
                                    <th class="text-center">Total Lease Intervals</th>
                                    <th class="text-center sortable" data-sort="exceptions" style="cursor: pointer;">
                                        Exceptions <i class="fas fa-sort-down"></i>
                                    </th>
                                    <th class="text-end">Undercharge</th>
                                    <th class="text-end">Overcharge</th>
                                    <th class="text-end">Total Variance</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for property in properties %}
                                <tr>
                                    <td><strong>{{ property.property_name if property.property_name else '-' }}</strong></td>
                                    <td>{{ property.property_id|int }}</td>
                                    <td class="text-center">{{ property.total_lease_intervals }}</td>
                                    <td class="text-center">
                                        {% if property.exception_buckets > 0 %}
                                            <i class="fas fa-exclamation-circle me-1" style="color: #c20068;"></i>{{ property.exception_buckets }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </td>
                                    <td class="text-end" style="color: #c20068;">
                                        {% if property.total_undercharge > 0 %}
                                            ${{ "{:,.0f}".format(property.total_undercharge) }}
                                        {% else %}
                                            $0
                                        {% endif %}
                                    </td>
                                    <td class="text-end" style="color: #00a8c8;">
                                        {% if property.total_overcharge > 0 %}
                                            ${{ "{:,.0f}".format(property.total_overcharge) }}
                                        {% else %}
                                            $0
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <strong>${{ "{:,.0f}".format(property.total_variance|abs) }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('main.property_view', property_id=property.property_id, run_id=run_id) }}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="row mt-3">
        <div class="col-12">
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Upload
            </a>
        </div>
    </div>
    
    <!-- Run Metadata -->
    <div class="row mt-3 mb-4">
        <div class="col-12">
            <p class="text-muted small">
                Most Recent Run: <code>{{ run_id }}</code> | 
                Executed: {{ metadata.timestamp }}
                {% if metadata.audit_period %}
                | <strong>Audit Period: 
                {% if metadata.audit_period.month %}
                    {{ ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][metadata.audit_period.month] }}
                {% endif %}
                {% if metadata.audit_period.year %}
                    {{ metadata.audit_period.year }}
                {% endif %}
                </strong>
                {% endif %}
                <br>Cumulative data from {{ total_runs }} audit run(s)
            </p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('propertiesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const searchInput = document.getElementById('propertySearch');
    const clearButton = document.getElementById('clearSearch');
    
    let currentSort = {
        column: 'exceptions',
        direction: 'desc'
    };
    
    // Store original data in rows
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        row.dataset.propertyName = cells[0].textContent.trim();
        row.dataset.exceptions = parseInt(cells[3].textContent.replace(/\D/g, '') || '0');
    });
    
    // Filter function
    function filterTable() {
        const filterValue = searchInput.value.toLowerCase().trim();
        
        rows.forEach(row => {
            const propertyName = row.dataset.propertyName.toLowerCase();
            if (filterValue === '' || propertyName.includes(filterValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Sort function
    function sortTable(column, direction) {
        const sortedRows = [...rows].sort((a, b) => {
            let aVal, bVal;
            
            if (column === 'property_name') {
                aVal = a.dataset.propertyName.toLowerCase();
                bVal = b.dataset.propertyName.toLowerCase();
                return direction === 'asc' 
                    ? aVal.localeCompare(bVal)
                    : bVal.localeCompare(aVal);
            } else if (column === 'exceptions') {
                aVal = parseInt(a.dataset.exceptions);
                bVal = parseInt(b.dataset.exceptions);
                return direction === 'asc' 
                    ? aVal - bVal
                    : bVal - aVal;
            }
            return 0;
        });
        
        // Clear and repopulate tbody
        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
        
        // Reapply filter after sorting
        filterTable();
        
        // Update sort icons
        table.querySelectorAll('.sortable i').forEach(icon => {
            icon.className = 'fas fa-sort-up text-muted';
        });
        
        const activeHeader = table.querySelector(`.sortable[data-sort="${column}"] i`);
        if (activeHeader) {
            activeHeader.className = direction === 'asc' 
                ? 'fas fa-sort-up'
                : 'fas fa-sort-down';
        }
        
        currentSort = { column, direction };
    }
    
    // Function to sort by property name (called from onclick)
    window.sortByPropertyName = function() {
        const direction = currentSort.column === 'property_name' && currentSort.direction === 'desc' 
            ? 'asc' 
            : 'desc';
        sortTable('property_name', direction);
        
        // Update the property name sort icon specifically
        const icon = document.getElementById('propertyNameSortIcon');
        if (icon) {
            icon.className = direction === 'asc' 
                ? 'fas fa-sort-up'
                : 'fas fa-sort-down';
        }
    };
    
    // Add click handlers to other sortable headers (exceptions)
    table.querySelectorAll('.sortable[data-sort="exceptions"]').forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.sort;
            const direction = currentSort.column === column && currentSort.direction === 'desc' 
                ? 'asc' 
                : 'desc';
            sortTable(column, direction);
        });
    });
    
    // Search input event listener
    searchInput.addEventListener('input', filterTable);
    
    // Clear button event listener
    clearButton.addEventListener('click', function(e) {
        e.stopPropagation();
        searchInput.value = '';
        filterTable();
        searchInput.focus();
    });
    
    // Handle datalist selection
    searchInput.addEventListener('change', filterTable);
    
    // Initial sort by exceptions (descending)
    sortTable('exceptions', 'desc');
});
</script>

{% endblock %}
