{% extends "base.html" %}

{% block title %}Portfolio Overview - Lease Audit{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2>PeakMade Portfolio</h2>
            <p class="text-muted small mb-0">
                <strong>Audit Run:</strong> <code>{{ run_id }}</code><br/>
                <strong>Executed:</strong> {{ metadata.timestamp }}<br/>
                {% if metadata.analysis_period %}
                <strong>Analyzing Data:</strong> {{ metadata.analysis_period }}
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Overall Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">Current Undercharge</h6>
                            <h3 class="mb-0" style="color: #c20068;">${{ "{:,.0f}".format(kpis.current_undercharge) }}</h3>
                            <small class="text-muted">Historical: ${{ "{:,.0f}".format(kpis.historical_undercharge) }}</small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">Current Overcharge</h6>
                            <h3 class="mb-0" style="color: #00a8c8;">${{ "{:,.0f}".format(kpis.current_overcharge) }}</h3>
                            <small class="text-muted">Historical: ${{ "{:,.0f}".format(kpis.historical_overcharge) }}</small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-2">Open Exceptions</h6>
                            <h3 class="mb-0" style="color: #ff6600;">{{ kpis.open_exceptions }}</h3>
                            <small class="text-muted">Match Rate: {{ "%.1f"|format(kpis.match_rate) }}%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Summary Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Properties</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="propertiesTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="property_name" style="cursor: pointer;">
                                        Property Name <span id="propertyNameSortIcon" style="font-size: 1em; color: #999;">↕</span>
                                    </th>
                                    <th>Property ID</th>
                                    <th class="text-center">Total Lease Intervals</th>
                                    <th class="text-center sortable" data-sort="exceptions" style="cursor: pointer;">
                                        Exceptions <span id="exceptionsSortIcon" style="font-size: 1em; color: #000;">↓</span>
                                    </th>
                                    <th class="text-end">Undercharge</th>
                                    <th class="text-end">Overcharge</th>
                                    <th class="text-end">Total Variance</th>
                                    <th class="text-center">Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for property in properties %}
                                <tr style="cursor: pointer; transition: background-color 0.15s;" 
                                    onclick="if(window.showPageLoadingOverlay) window.showPageLoadingOverlay(); window.location.href='{{ url_for('main.property_view', property_id=property.property_id, run_id=run_id) }}'">
                                    <td><strong>{{ property.property_name if property.property_name else '-' }}</strong></td>
                                    <td>{{ property.property_id|int }}</td>
                                    <td class="text-center">{{ property.total_lease_intervals }}</td>
                                    <td class="text-center">
                                        {% if property.exception_buckets > 0 %}
                                            <i class="fas fa-exclamation-circle me-1" style="color: #c20068;"></i>{{ property.exception_buckets }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </td>
                                    <td class="text-end" style="color: #c20068;">
                                        {% if property.total_undercharge > 0 %}
                                            ${{ "{:,.0f}".format(property.total_undercharge) }}
                                        {% else %}
                                            $0
                                        {% endif %}
                                    </td>
                                    <td class="text-end" style="color: #00a8c8;">
                                        {% if property.total_overcharge > 0 %}
                                            ${{ "{:,.0f}".format(property.total_overcharge) }}
                                        {% else %}
                                            $0
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <strong>${{ "{:,.0f}".format(property.total_variance|abs) }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <i class="fas fa-eye" style="color: #6c757d;"></i>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="row mt-3">
        <div class="col-12">
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Upload
            </a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('propertiesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    let currentSort = {
        column: 'exceptions',
        direction: 'desc'
    };
    
    // Store original data in rows
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        row.dataset.propertyName = cells[0].textContent.trim();
        row.dataset.exceptions = parseInt(cells[3].textContent.replace(/\D/g, '') || '0');
    });
    
    // Sort function
    function sortTable(column, direction) {
        const sortedRows = [...rows].sort((a, b) => {
            let aVal, bVal;
            
            if (column === 'property_name') {
                aVal = a.dataset.propertyName.toLowerCase();
                bVal = b.dataset.propertyName.toLowerCase();
                return direction === 'asc' 
                    ? aVal.localeCompare(bVal)
                    : bVal.localeCompare(aVal);
            } else if (column === 'exceptions') {
                aVal = parseInt(a.dataset.exceptions);
                bVal = parseInt(b.dataset.exceptions);
                return direction === 'asc' 
                    ? aVal - bVal
                    : bVal - aVal;
            }
            return 0;
        });
        
        // Clear and repopulate tbody
        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
        
        // Update sort icons
        table.querySelectorAll('.sortable span').forEach(icon => {
            icon.textContent = '↕';
            icon.style.color = '#999';
        });
        
        const activeHeader = table.querySelector(`.sortable[data-sort="${column}"] span`);
        if (activeHeader) {
            activeHeader.textContent = direction === 'asc' ? '↑' : '↓';
            activeHeader.style.color = '#000';
        }
        
        currentSort = { column, direction };
    }
    
    // Add click handlers to sortable headers
    table.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.sort;
            const direction = currentSort.column === column && currentSort.direction === 'desc' 
                ? 'asc' 
                : 'desc';
            sortTable(column, direction);
        });
    });
    
    // Initial sort by exceptions (descending)
    sortTable('exceptions', 'desc');
});
</script>

{% endblock %}
